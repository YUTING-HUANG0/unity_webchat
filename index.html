<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>智能知識助手系統</title>
    <style>
        :root { --bg-pure: #000; --panel-dark: #1a1a1a; --panel-light: #2d2d2d; --accent: #fff; --text-main: #f0f0f0; --text-dim: #a0a0a0; }
        body, html { padding: 0; margin: 0; height: 100vh; width: 100vw; background: var(--bg-pure); font-family: "Microsoft JhengHei", sans-serif; color: var(--text-main); overflow: hidden; }
        
        /* 保持畫布在畫面上但不可見，防止 Unity 停止運作 */
        #unity-canvas { position: absolute; top: 0; left: 0; width: 1px !important; height: 1px !important; opacity: 0; z-index: 1; }

        #web-ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; background: var(--bg-pure); }
        #header { padding: 1.5rem; text-align: center; border-bottom: 1px solid var(--panel-light); letter-spacing: 4px; font-weight: bold; }
        #chat-window { flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; max-width: 850px; margin: 0 auto; width: 100%; }
        .message { max-width: 80%; padding: 1rem 1.25rem; border-radius: 4px; font-size: 0.95rem; line-height: 1.6; }
        .bot-msg { align-self: flex-start; background: var(--panel-dark); border-left: 3px solid var(--accent); }
        .user-msg { align-self: flex-end; background: var(--panel-light); }
        .typing-msg { color: var(--text-dim); font-style: italic; display: none; }
        .suggestion-box { margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .suggestion-btn { background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); padding: 0.6rem; text-align: left; cursor: pointer; font-size: 0.85rem; }
        #input-area { padding: 2rem; background: var(--bg-pure); border-top: 1px solid var(--panel-light); }
        .input-container { max-width: 850px; margin: 0 auto; display: flex; gap: 1rem; }
        input { flex: 1; background: var(--panel-dark); border: 1px solid var(--panel-light); color: white; padding: 0.8rem 1.2rem; outline: none; font-size: 1rem; }
        .btn { padding: 0.8rem 1.5rem; cursor: pointer; font-weight: bold; border: none; }
        #send-btn { background: var(--accent); color: black; }
        #clear-btn { background: #333; color: white; }
    </style>
</head>
<body>
    <canvas id="unity-canvas"></canvas>
    <div id="web-ui-layer">
        <div id="header">智能知識助手系統</div>
        <div id="chat-window">
            <div class="message bot-msg">
                系統已就緒。您可以點擊下方預設問題，或直接輸入。
                <div class="suggestion-box">
                    <button class="suggestion-btn" onclick="askSuggestion('什麼是生成式AI（Generative AI）？')">· 什麼是生成式AI（Generative AI）？</button>
                    <button class="suggestion-btn" onclick="askSuggestion('TAM 的兩個核心構念是什麼？')">· TAM 的兩個核心構念是什麼？</button>
                </div>
            </div>
        </div>
        <div id="input-area">
            <div class="input-container">
                <button id="clear-btn" class="btn" onclick="clearConversation()">清空對話</button>
                <input type="text" id="userInput" placeholder="輸入訊息 (支援中英文)...">
                <button id="send-btn" class="btn" onclick="performSend()">送出</button>
            </div>
        </div>
    </div>

    <script>
        var unityInstance = null;
        var canvas = document.querySelector("#unity-canvas");

        var config = {
            dataUrl: "Build/knowledge-agent-api.data",
            frameworkUrl: "Build/knowledge-agent-api.framework.js",
            codeUrl: "Build/knowledge-agent-api.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "AgentKnowledgeTest",
            productVersion: "1.0",
        };

        var script = document.createElement("script");
        script.src = "Build/knowledge-agent-api.loader.js";
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {}).then((instance) => {
                unityInstance = instance;
                // 啟動後立刻告訴 Unity 不要攔截鍵盤，解決英文輸入問題
                instance.SendMessage('_Managers', 'SetCaptureAllKeyboardInput', 0);
            });
        };
        document.body.appendChild(script);

        // 送出邏輯
        function performSend() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text || !unityInstance) return;
            appendMsg('user', text);
            input.value = '';
            showTyping(true);
            unityInstance.SendMessage('_Managers', 'GetMessageFromHTML', text);
        }

        document.getElementById('userInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') performSend(); });

        function askSuggestion(text) {
            if (!unityInstance) return;
            appendMsg('user', text);
            showTyping(true);
            unityInstance.SendMessage('_Managers', 'GetMessageFromHTML', text);
        }

        function clearConversation() {
            if (confirm("確定要清空嗎？")) {
                if(unityInstance) unityInstance.SendMessage('_Managers', 'ClearChat');
                location.reload();
            }
        }

        function appendMsg(role, text) {
            if (text === "UNITY_READY") return;
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `message ${role}-msg`;
            div.innerText = text;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        function showTyping(isTyping) {
            const win = document.getElementById('chat-window');
            let typingDiv = document.getElementById('typing-indicator');
            if (isTyping) {
                if (!typingDiv) {
                    typingDiv = document.createElement('div');
                    typingDiv.id = 'typing-indicator';
                    typingDiv.className = 'message bot-msg';
                    typingDiv.style.color = '#a0a0a0';
                    typingDiv.innerText = '機器人正在思考...';
                    win.appendChild(typingDiv);
                }
                typingDiv.style.display = 'block';
            } else if (typingDiv) {
                typingDiv.style.display = 'none';
            }
            win.scrollTop = win.scrollHeight;
        }

        window.dispatchAnswerToHTML = function(answer) {
            showTyping(false);
            appendMsg('bot', answer);
        };

        window.setTypingStatus = function(isTyping) {
            document.getElementById('send-btn').disabled = (isTyping === 1);
            showTyping(isTyping === 1);
        };
    </script>
</body>
</html>