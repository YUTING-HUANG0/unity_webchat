<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>智能知識助手系統</title>
    <style>
        /* 1. 預設黑白灰風格 (Dark) */
        :root { 
            --bg-pure: #000; 
            --panel-msg: #1a1a1a; 
            --panel-user: #333333; 
            --accent: #ffffff; 
            --text-main: #f0f0f0; 
            --text-dim: #a0a0a0; 
            --input-bg: #1a1a1a;
            --btn-text: #000;
        }

        /* 2. 藍色舒適風格 (theme=blue) - 以 CAE9FF 為底 */
        [data-theme='blue'] {
            --bg-pure: #CAE9FF;     /* 背景：最淺 Columbia blue */
            --panel-msg: #ffffff;  /* 機器人訊息：純白 */
            --panel-user: #62B6CB; /* 使用者訊息：Moonstone */
            --accent: #1B4965;     /* 強調色：Indigo dye */
            --text-main: #1B4965;   /* 主文字：深藍 */
            --text-dim: #5FA8D3;    /* 輔助文字 */
            --input-bg: #f0f8ff;   /* 輸入框背景 */
            --btn-text: #ffffff;
        }

        /* 3. 綠色舒適風格 (theme=green) - 以最淺綠為底 */
        [data-theme='green'] {
            --bg-pure: #e9ece0;     /* 背景：最淺色 */
            --panel-msg: #ffffff;  /* 機器人訊息：純白 */
            --panel-user: #94a991; /* 使用者訊息：中階綠 */
            --accent: #4e6357;     /* 強調色：深綠 */
            --text-main: #4e6357;   /* 主文字：深綠 */
            --text-dim: #698474;    /* 輔助文字 */
            --input-bg: #f4f6f0;   /* 輸入框背景 */
            --btn-text: #ffffff;
        }

        body, html { padding: 0; margin: 0; height: 100vh; width: 100vw; background: var(--bg-pure); font-family: "Microsoft JhengHei", sans-serif; color: var(--text-main); overflow: hidden; transition: all 0.3s ease; }
        #unity-canvas { position: absolute; top: 0; left: 0; width: 1px !important; height: 1px !important; opacity: 0; z-index: 1; }
        #web-ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; background: var(--bg-pure); }
        #header { padding: 1.5rem; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.1); letter-spacing: 4px; font-weight: bold; background: rgba(255,255,255,0.1); }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; max-width: 850px; margin: 0 auto; width: 100%; }
        .message { max-width: 80%; padding: 1rem 1.25rem; border-radius: 12px; font-size: 0.95rem; line-height: 1.6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .bot-msg { align-self: flex-start; background: var(--panel-msg); border-left: 4px solid var(--accent); }
        .user-msg { align-self: flex-end; background: var(--panel-user); color: var(--btn-text); }
        
        .suggestion-box { margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .suggestion-btn { background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); padding: 0.6rem; text-align: left; cursor: pointer; font-size: 0.85rem; border-radius: 4px; }
        .suggestion-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,0,0,0.02); }

        #input-area { padding: 2rem; background: var(--bg-pure); border-top: 1px solid rgba(0,0,0,0.1); }
        .input-container { max-width: 850px; margin: 0 auto; display: flex; gap: 1rem; }
        input { flex: 1; background: var(--input-bg); border: 1px solid rgba(0,0,0,0.1); color: var(--text-main); padding: 0.8rem 1.2rem; outline: none; font-size: 1rem; border-radius: 8px; }
        .btn { padding: 0.8rem 1.5rem; cursor: pointer; font-weight: bold; border: none; border-radius: 8px; transition: opacity 0.2s; }
        #send-btn { background: var(--accent); color: var(--btn-text); }
        #clear-btn { background: #666; color: white; }
    </style>
</head>
<body>
    <canvas id="unity-canvas"></canvas>
    <div id="web-ui-layer">
        <div id="header">智能知識助手系統</div>
        <div id="chat-window">
            <div class="message bot-msg">
                系統已就緒。您可以點擊下方預設問題，或直接輸入。
                <div class="suggestion-box">
                    <button class="suggestion-btn" onclick="askSuggestion('什麼是生成式AI（Generative AI）？')">· 什麼是生成式AI（Generative AI）？</button>
                    <button class="suggestion-btn" onclick="askSuggestion('TAM 的兩個核心構念是什麼？')">· TAM 的兩個核心構念是什麼？</button>
                </div>
            </div>
        </div>
        <div id="input-area">
            <div class="input-container">
                <button id="clear-btn" class="btn" onclick="clearConversation()">清空對話</button>
                <input type="text" id="userInput" placeholder="輸入訊息...">
                <button id="send-btn" class="btn" onclick="performSend()">送出</button>
            </div>
        </div>
    </div>

    <script>
        function applyTheme() {
            const urlParams = new URLSearchParams(window.location.search);
            const theme = urlParams.get('theme');
            if (theme) document.documentElement.setAttribute('data-theme', theme);
        }
        applyTheme();

        var unityInstance = null;
        var canvas = document.querySelector("#unity-canvas");
        var config = {
            dataUrl: "Build/knowledge-agent-api.data",
            frameworkUrl: "Build/knowledge-agent-api.framework.js",
            codeUrl: "Build/knowledge-agent-api.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "AgentKnowledgeTest",
            productVersion: "1.0",
        };

        var script = document.createElement("script");
        script.src = "Build/knowledge-agent-api.loader.js";
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {}).then((instance) => {
                unityInstance = instance;
                instance.SendMessage('_Managers', 'SetCaptureAllKeyboardInput', 0);
            });
        };
        document.body.appendChild(script);

        function performSend() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text || !unityInstance) return;
            appendMsg('user', text);
            input.value = '';
            showTyping(true);
            unityInstance.SendMessage('_Managers', 'GetMessageFromHTML', text);
        }

        document.getElementById('userInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') performSend(); });

        function askSuggestion(text) {
            if (!unityInstance) return;
            appendMsg('user', text);
            showTyping(true);
            unityInstance.SendMessage('_Managers', 'GetMessageFromHTML', text);
        }

        function clearConversation() {
            if (confirm("確定要清空嗎？")) {
                if(unityInstance) unityInstance.SendMessage('_Managers', 'ClearChat');
                location.reload();
            }
        }

        function appendMsg(role, text) {
            if (text === "UNITY_READY") return;
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `message ${role}-msg`;
            div.innerText = text;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        function showTyping(isTyping) {
            const win = document.getElementById('chat-window');
            let typingDiv = document.getElementById('typing-indicator');
            if (isTyping) {
                if (!typingDiv) {
                    typingDiv = document.createElement('div');
                    typingDiv.id = 'typing-indicator';
                    typingDiv.className = 'message bot-msg';
                    typingDiv.innerText = '機器人正在思考...';
                    win.appendChild(typingDiv);
                }
                typingDiv.style.display = 'block';
            } else if (typingDiv) {
                typingDiv.style.display = 'none';
            }
            win.scrollTop = win.scrollHeight;
        }

        window.dispatchAnswerToHTML = function(answer) {
            showTyping(false);
            appendMsg('bot', answer);
        };

        window.setTypingStatus = function(isTyping) {
            document.getElementById('send-btn').disabled = (isTyping === 1);
            showTyping(isTyping === 1);
        };
    </script>
</body>
</html>
